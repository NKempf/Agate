---
title: "Maintenance des réseaux routiers"
author: "Nicolas Kempf"
date: "19 mars 2018"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r,echo=FALSE,include=FALSE}
library(prettydoc)
```

Agate utilise des réseaux routiers issus de l'IGN. L'application a besoin de deux fichiers cartographiques : le reseau routiers composé de lignes spatiales et des noeuds routiers correspondant (composé de points spatiaux). Afin d'améliorer la précision du distancier, le reseau routier est découpé en tronçon de 100 m de long maximum.

Il existe plusieurs types de routes et de chemin. On selectionne uniquement les types suivants :
Autoroute
Bretelle
Quasi-autoroute
Route à 2 chaussées
Route à 1 chaussée
Route empierrée
Chemin
Bac auto





## Guadeloupe

Les dépendances sont connectées au réseau routier via des voies maritimes. À noter, la connexion entre le port de Saint-François et la Désirade n'est pas correctement faite. La voie maritime s'arrête dans le port sans aller jusqu'à un noeud routier.

![Avant](R971_BasAuto_corr1.png)

La correction a été effectuée manuellement dans QGIS en prologeant le trajet maritime jusqu'a la jetée.

![Après](R971_BasAuto_corr2.png)

Le même problème se produit à Grand-Bourg de Marie-galante. 

![Avant](R971_BasAuto_corr3.png)

La correction a été effectuée manuellement dans QGIS en prologeant le trajet maritime jusqu'a la jetée.

![Avant](R971_BasAuto_corr4.png)

Attention, la connexion manuelle avec le réseau routier se fait dans Qgis et est susceptible de ne pas se raccorder correctement. Le principal inconvient est que l'on crée sans s'en rendre comptes des sommets de routes juste à coté d'autres (quelques cm en réel par moment). « GRASS », une extension de Qgis permet de résoudre ce problème.

## Martinique

Le réseau routier martiniquais est composé de nombreux chemins non reliés correctement aux routes goudronnées. Ces chemins se trouvent en zones non habitées. Par conséquent, ils sont laissés tel quel dans le fichier. Pour l'instant, je n'ai pas réussi à trouver une méthode efficace de détection.

## Guyane

Après réflexion, les fleuves et rivières Guyanais ne sont pas entièrement connectés avec le réseau routier. La raison principale est d'éviter de multiplier les petits trajets en bateau et en voiture. Par exemple, on ne souhaite pas obtenir de trajet où un guyanais devrait prendre 2 bateaux et 3 voitures pour se rendre au médecin le plus proche. Ce n'est pas cohérent avec la réalité. Pour se rendre quelque part les individus ont tendance à minimiser le nombre de moyen de transport différent. 

Par conséquent, on identifie les logements isolés du réseau routier. Ils se trouvent en général sur des îles du Saint-Laurent ou dans des zones intérieures en Guyane. Après les avoir identifiés dans R, on bascule sous Qgis pour rajouter manuellement les voies navigables pertinentes et effectuer la connexion (toujours manuellement) avec le réseau routier. L'idée principale est de connecter les îles à la route principale la plus proche sur le réseau routier continentale. 

Ainsi, on crée deux types de routes supplémentaires : les « Fleuve » et les « Mer ». On affecte une vitesse de 6 km/h sur les fleuves et 10 km/h sur mer. 

Attention, la connexion manuelle avec le réseau routier se fait dans Qgis et est susceptible de ne pas se raccorder correctement. Le principal inconvient est que l'on crée sans s'en rendre comptes des sommets de routes juste à cté d'autres (quelques cm en réelle par moment). Du coup, R pense que ces routes ne sont pas connectées. Pour résoudre ce problème, j'ai utilisé l'extension « GRASS » de Qgis. « GRASS » permet de nettoyer les couches cartographie


## Nettoyage du réseau routier avec GRASS (Extension Qgis)

Cet extension connecte automatiquement toutes les routes dont les sommets sont très proches (quelques dizaines de centimètres au maximum). Voici la démarche à effectuer : 

1) Créer un « nouveau jeu de données ». L'idée est de créer un fichier (vide au début) qui va ensuite contenir les différentes manipulations sur les couches cartographiques. La création de ce fichier permet par la suite le déblocation du bouton « Ouvrir les outils GRASS »

![(1/3)](R971_GRASSNett_1.png)

![(2/3)](R971_GRASSNett_2.png)

![(3/3)](R971_GRASSNett_3.png)

2) Cliquer sur « Ouvrir les outils GRASS ». Puis se rendre sur la page « Arborescence des modules »

![Outils Grass](R971_GRASSNett_4.png)

3) Choisir « Gestion de fichier », « Importer dans GRASS », « Importer un vecteur dans GRASS », « v.in.ogr.qgis » si votre couche est déjà chargée dans Qgis. Suivre l'assistant. Une fois la couche chargée dans GRASS, n'oubliez pas de cliquer sur « vue » pour la faire apparaître dans QG

![Outils Grass](R971_GRASSNett_5.png)

![Outils Grass](R971_GRASSNett_6.png)

4) Pour nettoyer le réseau routier, retournez dans l'« Arborescence des modules », puis dans « vecteur », « Développer la carte », « Outils pour nettoyer la topologie d'une carte vecteur ».

![Outils Grass](R971_GRASSNett_7.png)

5) Utiliser le module « v.clean.snap » pour corriger les connexions entre lignes défectueuses. J'ai utilisé une tolérance de 10 unité de carte.

![Outils Grass](R971_GRASSNett_8.png)

6) Utiliser le module « v.clean.break » pour tronçonner les routes à chaque intersection de routes. Le module « v.clean.snap » nous a permis de corriger les erreurs de connexions entre routes mais a parfois modifié légèrement le tracé et donc modifié certains carrefours routiers.

![Outils Grass](R971_GRASSNett_9.png)

![Outils Grass](R971_GRASSNett_10.png)

### Transformation des routes en segment de 100 m maximum

Segmentation du réseau routier en tronçons inférieurs à 100 m. Cela permet de gérer les distances de marches entre une habitation et un nœud routier. 

On utilise le plugin GRASS de Qgis. (Reprendre les phases 1 à 3 de la partie précedente pour le chargement des données dans GRASS)

7) À partir de l'arborescence des modules, aller dans "vecteur", "Developper la carte", "Gestion des entités", utiliser le module « v.split » pour segmenter les routes en segment de 100 m maximum de long.

![Outils Grass](R971_GRASSNett_11.png)

![Outils Grass](R971_GRASSNett_12.png)

Attention ! Le principal incovenient de ces méthodes est la modification des objets spatiaux. Les géometries des objets peuvent contenir des nouvelles intersections qui n'existe pas en réalité. De plus, cette démarche aboutit à la création de route composées de 0 ou 1 points ce qui empêche la mise en oeuvre des méthodes du package rgeos dans R. Pour résoudre le problème, j'ai développé une fonction R (zonaNettRoute) qui supprime ces routes. 

### Chargement de la couche nettoyée dans R

Pour une raison inconnue, R intreprete mal le fichier .prj associé au réseau routier nettoyé. Il faut par conséquent forcer le système de projection dans R de la manière suivante : 



