library(tidyverse)
library(sp)

# Extraction des polygones
load("Data/Tmp/leafLetDraw2.RData")
liste$features[[1]]$properties <- "nard"
liste$features[[1]]$properties

# I. Algorithme de conversion d'une feature issue du package leaflet.extras vers un spatialpolygondataframe du package sp
#------------------------------------------------------------------------------------------------------------------------

# 1) Conversion de chaque feature en liste de data.frame contenant les coordonnées de chaque point permettant
# de construire les polygones.
# Chaque élément de la liste définit un polygone
ldf <- lapply(liste$features, function(x){
  lapply(x$geometry[[2]][[1]], function(l){
    data.frame(matrix(unlist(l), nrow=1, byrow=T))
  }) %>% 
    bind_rows() %>% 
    rename(x = X1, y = X2)
})
# Changement des noms des polygones
names(ldf) <- paste0("pol",seq(1:length(liste$features)))

# 2) Conversion en polygon
ps <- lapply(ldf, Polygon)

# 3) Conversion en objet polygon
p1 <- lapply(seq_along(ps), function(i) Polygons(list(ps[[i]]), 
                                                 ID = names(ldf)[i]  ))
# 4) Conversion en spatialpolygon
poly_drawn <- SpatialPolygons(p1, proj4string = CRS("+init=epsg:4326")) 

# 5) Creation d'une table atttributaire avec des valeurs par défauts
table_attribut <- data.frame(id = paste0("pol",seq(1:length(liste$features))),name = NA)
rownames(table_attribut) <- table_attribut$id # Important pour créer l'objet spatialpolygondataframe

# 6) Creation d'un spatialpolygonDataframe
zone <- SpatialPolygonsDataFrame(poly_drawn,data = table_attribut)

# 7) Affichage de la carte pour test
plot(poly_drawn)

leaflet() %>% addTiles() %>% 
  addPolygons(data=poly_drawn)

# II. Automatisation de l'algorithme
#--------------------------------------------------------------------------------------------------------------------

# feature : liste de feature issue du package leaflet.extras
featureToSpatialPolygonDF <- function(featureList){
  
  # 1) FeatureList to data.frame list of coordinates (note : each data.frame contain polygon coordinates)
  ldf <- lapply(featureList$features, function(x){
    lapply(x$geometry[[2]][[1]], function(l){
      data.frame(matrix(unlist(l), nrow=1, byrow=T))
    }) %>% 
      bind_rows() %>% 
      rename(x = X1, y = X2)
  })
  
  # Polygon names
  names(ldf) <- paste0("pol",seq(1:length(featureList$features)))
  
  # 2) Convert data.frame to polygon objects 
  ps <- lapply(ldf, Polygon)
  
  # 3) Polygon object to Polygon list with correct IDs
  p1 <- lapply(seq_along(ps), function(i) Polygons(list(ps[[i]]), 
                                                   ID = names(ldf)[i]  ))
  # 4) Convert into SpatialPolygon object (note : Leaflet object use projection system -> epsg4326)
  poly_drawn <- SpatialPolygons(p1, proj4string = CRS("+init=epsg:4326")) 
  
  # 5) Attribut data with default value
  table_attribut <- data.frame(id = paste0("pol",seq(1:length(liste$features))),name = NA)
  rownames(table_attribut) <- table_attribut$id # Important to create SpatialPolygonDataFrame
  
  # 6) Convert into spatialPolygonDataFrame object
  zone <- SpatialPolygonsDataFrame(poly_drawn,data = table_attribut)
  
  return(zone)
}

# 1) Essai 
zone <- featureToSpatialPolygonDF(featureList = liste)

# 2) Affichage de la carte pour test
leaflet() %>% addTiles() %>% 
  addPolygons(data=zone)
